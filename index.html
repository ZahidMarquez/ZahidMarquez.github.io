

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Lista de Espera Interactiva</title>

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 20px;
    background: linear-gradient(135deg, #c7f0f9, #fdd6e3);
}

h2, h3 { text-align: center; }

input, button, select {
    margin: 5px;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
}

button { cursor: pointer; font-weight: bold; }

ul { list-style: none; padding: 0; }

li {
    margin: 10px 0;
    padding: 15px;
    border-radius: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

li.aeromexico { background: #a8dadc; }
li.platinum  { background: #d6cadd; }
li.centurion { background: #ffd6a5; }

.btn-llamar { background: #a8dadc; border: none; }
.btn-stop   { background: #ffb5a7; border: none; }

.exportar { background: #bde0fe; }
.borrar   { background: #ffc8dd; }
</style>
</head>

<body>

<h2>ğŸ“‹ Lista de Espera âœˆï¸</h2>

<div style="text-align:center;">
<input type="text" id="nombre" placeholder="Nombre del pasajero">

<input
  type="number"
  id="pasajeros"
  placeholder="NÃºmero de pasajeros"
  min="1"
  step="1"
  inputmode="numeric"
  onkeydown="return (event.key >= '0' && event.key <= '9') || ['Backspace','Delete','ArrowLeft','ArrowRight','Tab'].includes(event.key)"
>

<select id="tipo">
  <option value="Aeromexico">Aeromexico</option>
  <option value="Platinum">Platinum</option>
  <option value="Centurion">Centurion</option>
</select>
<br>
<button id="btnAgregar">Agregar</button>
<button id="btnPantalla">ğŸ“º Pantalla</button>
</div>

<h3>Pasajeros en espera</h3>
<ul id="lista"></ul>

<h3>Historial</h3>
<ul id="historial"></ul>

<h3>Total de personas: <span id="total">0</span></h3>

<div style="text-align:center;">
<button class="exportar" onclick="exportarExcel()">ğŸ’¾ Descargar Excel</button>
<button class="borrar" onclick="borrarHistorial()">ğŸ—‘ï¸ Borrar historial</button>
</div>

<audio id="sonidoLlamado" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
// ===== STORAGE =====
let totalPersonas = Number(localStorage.getItem("totalPersonas")) || 0;
let historial = JSON.parse(localStorage.getItem("historial")) || [];
let listaEspera = JSON.parse(localStorage.getItem("listaEspera")) || [];
let codigoCounter = Number(localStorage.getItem("codigoCounter")) || 1;

document.getElementById("total").textContent = totalPersonas;
renderLista();
renderHistorial();

// ===== AGREGAR =====
document.getElementById("btnAgregar").addEventListener("click", () => {
    const nombre = document.getElementById("nombre").value.trim();
    const pasajerosInput = document.getElementById("pasajeros").value.trim();
    const tipo = document.getElementById("tipo").value;

    if (!nombre) return alert("Ingrese el nombre del pasajero.");
    if (!/^[1-9][0-9]*$/.test(pasajerosInput))
        return alert("Ingrese solo nÃºmeros enteros mayores a 0.");

    const pasajeros = Number(pasajerosInput);

    const codigo = "AE-" + codigoCounter.toString().padStart(4,"0");
    codigoCounter++;
    localStorage.setItem("codigoCounter", codigoCounter);

    const pasajero = {
        codigo, nombre, pasajeros, tipo,
        horaRegistro: new Date().toLocaleString()
    };

    listaEspera.push(pasajero);
    localStorage.setItem("listaEspera", JSON.stringify(listaEspera));

    totalPersonas += pasajeros;
    localStorage.setItem("totalPersonas", totalPersonas);
    document.getElementById("total").textContent = totalPersonas;

    renderLista();
    document.getElementById("nombre").value = "";
    document.getElementById("pasajeros").value = "";
});

// ===== LLAMAR =====
function llamarPasajero(codigo){
    const pas = listaEspera.find(p => p.codigo === codigo);
    if (!pas) return;

    localStorage.setItem("llamadaActiva", JSON.stringify(pas));
    localStorage.setItem("actualizarPantalla", Date.now());
    document.getElementById("sonidoLlamado").play();
}

// ===== FINALIZAR =====
function detenerLlamada(codigo){
    const idx = listaEspera.findIndex(p => p.codigo === codigo);
    if (idx < 0) return;

    const pas = listaEspera[idx];
    listaEspera.splice(idx, 1);
    localStorage.setItem("listaEspera", JSON.stringify(listaEspera));

    historial.push({ ...pas, horaLlamado: new Date().toLocaleString() });
    localStorage.setItem("historial", JSON.stringify(historial));

    totalPersonas -= pas.pasajeros;
    localStorage.setItem("totalPersonas", totalPersonas);
    document.getElementById("total").textContent = totalPersonas;

    localStorage.setItem("llamadaActiva", "null");
    localStorage.setItem("actualizarPantalla", Date.now());

    renderLista();
    renderHistorial();
}

// ===== RENDER LISTA =====
function renderLista(){
    const ul = document.getElementById("lista");
    ul.innerHTML = "";

    listaEspera.forEach(p => {
        const li = document.createElement("li");
        li.className = p.tipo.toLowerCase();
        li.innerHTML = `<strong>${p.codigo}</strong> â€” ${p.nombre} â€” ${p.pasajeros} pax â€” ${p.tipo}`;

        const btnCall = document.createElement("button");
        btnCall.textContent = "Llamar";
        btnCall.className = "btn-llamar";
        btnCall.onclick = () => llamarPasajero(p.codigo);

        const btnStop = document.createElement("button");
        btnStop.textContent = "Finalizar";
        btnStop.className = "btn-stop";
        btnStop.onclick = () => detenerLlamada(p.codigo);

        li.append(btnCall, btnStop);
        ul.appendChild(li);
    });
}

// ===== RENDER HISTORIAL =====
function renderHistorial(){
    const ul = document.getElementById("historial");
    ul.innerHTML = "";
    historial.forEach(h => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${h.codigo}</strong> â€” ${h.nombre} â€” ${h.pasajeros} pax â€” ${h.tipo}`;
        ul.appendChild(li);
    });
}

// ===== EXCEL =====
function exportarExcel(){
    if(historial.length === 0) return alert("No hay datos para exportar.");

    const wb = XLSX.utils.book_new();
    const tipos = ["Aeromexico","Platinum","Centurion"];

    tipos.forEach(tipo => {
        const data = historial.filter(h => h.tipo === tipo);
        if(data.length){
            const ws = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, tipo);
        }
    });

    const fecha = new Date().toISOString().slice(0,10);
    XLSX.writeFile(wb, `historial_lista_espera_${fecha}.xlsx`);
}

// ===== BORRAR HISTORIAL =====
function borrarHistorial(){
    if(!confirm("Â¿Seguro que deseas borrar TODO el historial?")) return;
    historial = [];
    localStorage.setItem("historial","[]");
    renderHistorial();
}

// ===== PANTALLA =====
document.getElementById("btnPantalla").addEventListener("click", () => {
    window.open("pantalla.html", "_blank");
});
</script>

</body>
</html>
