

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Lista de Espera Interactiva</title>

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 20px;
    background: linear-gradient(135deg, #c7f0f9, #fdd6e3);
}

h2, h3 { text-align: center; }

input, button, select {
    margin: 5px;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
}

button { cursor: pointer; font-weight: bold; }

ul { list-style: none; padding: 0; }

li {
    margin: 10px 0;
    padding: 15px;
    border-radius: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

li.aeromexico { background: #a8dadc; }
li.platinum  { background: #d6cadd; }
li.centurion { background: #ffd6a5; }

.btn-llamar { background: #a8dadc; border: none; }
.btn-stop   { background: #ffb5a7; border: none; }

.exportar { background: #bde0fe; }
.borrar   { background: #ffc8dd; }
</style>
</head>

<body>

<h2>üìã Lista de Espera ‚úàÔ∏è</h2>

<div style="text-align:center;">
<input type="text" id="nombre" placeholder="Nombre del pasajero">

<input
  type="number"
  id="pasajeros"
  placeholder="N√∫mero de pasajeros"
  min="1"
  step="1"
  inputmode="numeric"
  onkeydown="return (event.key >= '0' && event.key <= '9') || ['Backspace','Delete','ArrowLeft','ArrowRight','Tab'].includes(event.key)"
>

<select id="tipo">
  <option value="Aeromexico">Aeromexico</option>
  <option value="Platinum">Platinum</option>
  <option value="Centurion">Centurion</option>
</select>
<br>
<button id="btnAgregar">Agregar</button>
<button id="btnPantalla">üì∫ Pantalla</button>

<!-- TOGGLE TICKET -->
<div style="margin-top:10px;">
    <label style="font-weight:bold;">
        <input type="checkbox" id="toggleTicket">
        üñ®Ô∏è Imprimir ticket autom√°ticamente
    </label>
</div>
</div>

<h3>Pasajeros en espera</h3>
<ul id="lista"></ul>

<h3>Historial</h3>
<ul id="historial"></ul>

<h3>Total de personas: <span id="total">0</span></h3>

<div style="text-align:center;">
<button class="exportar" onclick="exportarExcel()">üíæ Descargar Excel</button>
<button class="borrar" onclick="borrarHistorial()">üóëÔ∏è Borrar historial</button>
</div>

<audio id="sonidoLlamado" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
// ===== STORAGE =====
let totalPersonas = Number(localStorage.getItem("totalPersonas")) || 0;
let historial = JSON.parse(localStorage.getItem("historial")) || [];
let listaEspera = JSON.parse(localStorage.getItem("listaEspera")) || [];
let codigoCounter = Number(localStorage.getItem("codigoCounter")) || 1;

// ===== TICKET =====
let imprimirTicket = localStorage.getItem("imprimirTicket") === "true";
const toggleTicket = document.getElementById("toggleTicket");
toggleTicket.checked = imprimirTicket;

toggleTicket.addEventListener("change", () => {
    imprimirTicket = toggleTicket.checked;
    localStorage.setItem("imprimirTicket", imprimirTicket);
});

document.getElementById("total").textContent = totalPersonas;
renderLista();
renderHistorial();

// ===== AGREGAR =====
document.getElementById("btnAgregar").addEventListener("click", () => {
    const nombre = document.getElementById("nombre").value.trim();
    const pasajerosInput = document.getElementById("pasajeros").value.trim();
    const tipo = document.getElementById("tipo").value;

    if (!nombre) return alert("Ingrese el nombre del pasajero.");
    if (!/^[1-9][0-9]*$/.test(pasajerosInput))
        return alert("Ingrese solo n√∫meros enteros mayores a 0.");

    const pasajeros = Number(pasajerosInput);
    const codigo = "AE-" + codigoCounter.toString().padStart(4,"0");
    codigoCounter++;
    localStorage.setItem("codigoCounter", codigoCounter);

    const pasajero = {
        codigo, nombre, pasajeros, tipo,
        horaRegistro: new Date().toLocaleString()
    };

    if (imprimirTicket) {
        imprimirTicketPasajero(pasajero);
    }

    listaEspera.push(pasajero);
    localStorage.setItem("listaEspera", JSON.stringify(listaEspera));

    totalPersonas += pasajeros;
    localStorage.setItem("totalPersonas", totalPersonas);
    document.getElementById("total").textContent = totalPersonas;

    renderLista();
    document.getElementById("nombre").value = "";
    document.getElementById("pasajeros").value = "";
});

// ===== IMPRIMIR TICKET =====
function imprimirTicketPasajero(p) {
    const v = window.open("", "PRINT", "width=300,height=400");
    v.document.write(`
        <html><head>
        <title>Ticket</title>
        <style>
            body{font-family:monospace;text-align:center;}
            h2{margin:5px 0;}
            hr{margin:10px 0;}
        </style>
        </head>
        <body>
            <h2>LISTA DE ESPERA</h2>
            <hr>
            <p><strong>${p.codigo}</strong></p>
            <p>${p.nombre}</p>
            <p>${p.pasajeros} pasajeros</p>
            <p>${p.tipo}</p>
            <hr>
            <p>${p.horaRegistro}</p>
        </body></html>
    `);
    v.document.close();
    v.focus();
    v.print();
    v.close();
}

// ===== LLAMAR =====
function llamarPasajero(codigo){
    const pas = listaEspera.find(p => p.codigo === codigo);
    if (!pas) return;
    localStorage.setItem("llamadaActiva", JSON.stringify(pas));
    localStorage.setItem("actualizarPantalla", Date.now());
    document.getElementById("sonidoLlamado").play();
}

// ===== FINALIZAR =====
function detenerLlamada(codigo){
    const idx = listaEspera.findIndex(p => p.codigo === codigo);
    if (idx < 0) return;

    const pas = listaEspera[idx];
    listaEspera.splice(idx, 1);
    localStorage.setItem("listaEspera", JSON.stringify(listaEspera));

    historial.push({ ...pas, horaLlamado: new Date().toLocaleString() });
    localStorage.setItem("historial", JSON.stringify(historial));

    totalPersonas -= pas.pasajeros;
    localStorage.setItem("totalPersonas", totalPersonas);
    document.getElementById("total").textContent = totalPersonas;

    localStorage.setItem("llamadaActiva", "null");
    localStorage.setItem("actualizarPantalla", Date.now());

    renderLista();
    renderHistorial();
}

// ===== RENDER =====
function renderLista(){
    const ul = document.getElementById("lista");
    ul.innerHTML = "";
    listaEspera.forEach(p => {
        const li = document.createElement("li");
        li.className = p.tipo.toLowerCase();
        li.innerHTML = `<strong>${p.codigo}</strong> ‚Äî ${p.nombre} ‚Äî ${p.pasajeros} pax ‚Äî ${p.tipo}`;

        const b1 = document.createElement("button");
        b1.textContent = "Llamar";
        b1.className = "btn-llamar";
        b1.onclick = () => llamarPasajero(p.codigo);

        const b2 = document.createElement("button");
        b2.textContent = "Finalizar";
        b2.className = "btn-stop";
        b2.onclick = () => detenerLlamada(p.codigo);

        li.append(b1, b2);
        ul.appendChild(li);
    });
}

function renderHistorial(){
    const ul = document.getElementById("historial");
    ul.innerHTML = "";
    historial.forEach(h => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${h.codigo}</strong> ‚Äî ${h.nombre} ‚Äî ${h.pasajeros} pax ‚Äî ${h.tipo}`;
        ul.appendChild(li);
    });
}

// ===== EXCEL =====
function exportarExcel(){
    if(historial.length === 0) return alert("No hay datos para exportar.");
    const wb = XLSX.utils.book_new();
    ["Aeromexico","Platinum","Centurion"].forEach(t => {
        const d = historial.filter(h => h.tipo === t);
        if(d.length){
            const ws = XLSX.utils.json_to_sheet(d);
            XLSX.utils.book_append_sheet(wb, ws, t);
        }
    });
    XLSX.writeFile(wb, `historial_${new Date().toISOString().slice(0,10)}.xlsx`);
}

// ===== BORRAR =====
function borrarHistorial(){
    if(!confirm("¬øBorrar todo el historial?")) return;
    historial = [];
    localStorage.setItem("historial","[]");
    renderHistorial();
}

// ===== PANTALLA =====
document.getElementById("btnPantalla").addEventListener("click", () => {
    window.open("pantalla.html", "_blank");
});
</script>

</body>
</html>

