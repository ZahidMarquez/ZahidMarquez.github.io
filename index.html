<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>LISTA DE ESPERA GZOM</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{
  --azul:#006FCF;
  --gris:#F4F6F9;
  --verde:#007A5A;
  --rojo:#C62828;
  --morado:#003A8F;
}

body{
  margin:0;
  font-family:Segoe UI,sans-serif;
  background:var(--gris);
  color:#000;
}
body.dark{background:#0B0B0B;color:#fff;}

header{
  background:var(--azul);
  color:#fff;
  padding:14px;
  text-align:center;
  font-size:22px;
}

.container{max-width:1400px;margin:auto;padding:16px;}

.card{
  background:#fff;
  padding:14px;
  border-radius:6px;
  margin-bottom:14px;
  box-shadow:0 4px 10px rgba(0,0,0,.1);
}
body.dark .card{background:#111827;}

label{
  display:block;
  font-weight:600;
  font-size:12px;
  margin-bottom:4px;
}

input,select{
  padding:8px;
  font-size:14px;
  width:100%;
  height:36px;
  box-sizing:border-box;
  border-radius:4px;
}

.form-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:14px;
  align-items:end;
}

button{
  border:none;
  padding:8px 12px;
  border-radius:4px;
  color:#fff;
  cursor:pointer;
  margin:4px;
}

.primary{background:var(--azul);}
.rojo{background:var(--rojo);}
.llamar{background:var(--verde);}
.finalizar{background:var(--morado);}
.retirada{background:#6b7280;}

.stats-container{display:flex;gap:12px;flex-wrap:wrap;}
.stat-card{
  flex:1 1 200px;
  padding:12px;
  border-radius:8px;
  color:#fff;
  text-align:center;
}

.stat-total{background:var(--azul);}
.stat-pax{background:var(--verde);}
.stat-prom{background:var(--morado);}
.stat-atendidos{background:#374151;}

table{width:100%;border-collapse:collapse;font-size:12px;}
th{background:var(--azul);color:#fff;padding:6px;}
td{border:1px solid #ccc;padding:5px;text-align:center;}
</style>
</head>

<body>
<header>âœˆ LISTA DE ESPERA</header>

<div class="container">

<div class="card">
  <div class="form-grid">
    <div>
      <label>Nombre</label>
      <input id="nombre">
    </div>
    <div>
      <label>Pax</label>
      <input id="cantidad" type="number" min="1" value="1">
    </div>
    <div>
      <label>Tarjeta</label>
      <select id="tarjeta">
        <option>Centurion</option>
        <option>Platino</option>
        <option>Aeromexico</option>
      </select>
    </div>
  </div>
  <button class="primary" id="btnRegistrar">âž• Registrar</button>
</div>

<div class="card">
  <button class="primary" onclick="descargarExcel()">ðŸ“Š Descargar Excel</button>
  <button class="rojo" onclick="borrarTodo()">ðŸ—‘ Borrar Todos los Registros</button>
</div>

<div class="card stats-container">
  <div class="stat-card stat-total">
    En espera<br><h3 id="totalRegistros">0</h3>
  </div>

  <div class="stat-card stat-pax">
    Pax en espera<br><h3 id="totalPax">0</h3>
  </div>

  <div class="stat-card stat-prom">
    Prom. Centurion<br><h3 id="promCenturion">0</h3>
  </div>

  <div class="stat-card stat-prom">
    Prom. Platino<br><h3 id="promPlatino">0</h3>
  </div>

  <div class="stat-card stat-prom">
    Prom. Aeromexico<br><h3 id="promAero">0</h3>
  </div>

  <div class="stat-card stat-prom">
    Prom. General<br><h3 id="promGeneral">0</h3>
  </div>

  <div class="stat-card stat-atendidos">
    Pax Atendidos<br><h3 id="totalAtendidos">0</h3>
  </div>
</div>

<div class="card">
<h3>Turnos en espera</h3>
<table>
<thead>
<tr>
<th>Turno</th><th>Nombre</th><th>Pax</th>
<th>Tarjeta</th><th>Registro</th><th>Llamada</th>
<th>Estado</th><th>Acciones</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>
</div>

</div>

<script>
const nombre = document.getElementById("nombre");
const cantidad = document.getElementById("cantidad");
const tarjeta = document.getElementById("tarjeta");
const btnRegistrar = document.getElementById("btnRegistrar");
const tabla = document.getElementById("tabla");

let espera = JSON.parse(localStorage.getItem("espera")) || [];
let historial = JSON.parse(localStorage.getItem("historial")) || [];
let turnoActual = espera.length ? espera[espera.length-1].turno + 1 : 1;

function guardar(){
  localStorage.setItem("espera", JSON.stringify(espera));
  localStorage.setItem("historial", JSON.stringify(historial));
}

/* ðŸ”¥ PRIORIDAD SOLO PARA CENTURION */
function ordenarEspera(){
  espera.sort((a,b)=>{

    if(a.tarjeta === "Centurion" && b.tarjeta !== "Centurion"){
      return -1;
    }

    if(a.tarjeta !== "Centurion" && b.tarjeta === "Centurion"){
      return 1;
    }

    return a.registro - b.registro;
  });
}

btnRegistrar.addEventListener("click",()=>{
  if(!nombre.value) return alert("Nombre requerido");

  const nuevo = {
    turno: turnoActual++,
    nombre: nombre.value,
    cantidad: +cantidad.value,
    tarjeta: tarjeta.value,
    registro: Date.now(),
    llamada: null,
    estado: "Pendiente"
  };

  espera.push(nuevo);
  guardar();
  render();

  nombre.value="";
  cantidad.value=1;
});

function render(){
  ordenarEspera();

  tabla.innerHTML="";

  espera.forEach((p,i)=>{
    tabla.innerHTML+=`
    <tr>
      <td>${p.turno}</td>
      <td>${p.nombre}</td>
      <td>${p.cantidad}</td>
      <td>${p.tarjeta}</td>
      <td>${new Date(p.registro).toLocaleTimeString()}</td>
      <td>${p.llamada?new Date(p.llamada).toLocaleTimeString():"---"}</td>
      <td>${p.estado}</td>
      <td>
        <button class="llamar" onclick="llamar(${i})">Llamar</button>
        <button class="finalizar" onclick="finalizar(${i})">Finalizar</button>
        <button class="retirada" onclick="retirada(${i})">Retirada</button>
      </td>
    </tr>`;
  });

  totalRegistros.innerText = espera.length;
  totalPax.innerText = espera.reduce((a,b)=>a+b.cantidad,0);

  calcularPromedios();
}

function llamar(i){
  espera[i].llamada = Date.now();
  guardar();
  render();
}

function finalizar(i){
  const p = espera[i];
  const minutos = Math.floor((Date.now()-p.registro)/60000);
  historial.push({...p, esperaMin:minutos});
  espera.splice(i,1);
  guardar();
  render();
}

function retirada(i){
  espera.splice(i,1);
  guardar();
  render();
}

function promedioPorTarjeta(tipo){
  const datos = historial.filter(p=>p.tarjeta===tipo);
  if(!datos.length) return 0;
  return (datos.reduce((a,b)=>a+b.esperaMin,0)/datos.length).toFixed(1);
}

function promedioGeneral(){
  if(!historial.length) return 0;
  return (historial.reduce((a,b)=>a+b.esperaMin,0)/historial.length).toFixed(1);
}

function calcularPromedios(){
  promCenturion.innerText = promedioPorTarjeta("Centurion")+" min";
  promPlatino.innerText = promedioPorTarjeta("Platino")+" min";
  promAero.innerText = promedioPorTarjeta("Aeromexico")+" min";
  promGeneral.innerText = promedioGeneral()+" min";
  totalAtendidos.innerText = historial.reduce((a,b)=>a+b.cantidad,0);
}

function descargarExcel(){
  const wb = XLSX.utils.book_new();
  const wsEspera = XLSX.utils.json_to_sheet(espera);
  const wsHistorial = XLSX.utils.json_to_sheet(historial);

  XLSX.utils.book_append_sheet(wb, wsEspera, "En Espera");
  XLSX.utils.book_append_sheet(wb, wsHistorial, "Atendidos");

  XLSX.writeFile(wb, "reporte_lista_espera.xlsx");
}

function borrarTodo(){
  if(confirm("Â¿Seguro que deseas borrar TODOS los registros?")){
    espera=[];
    historial=[];
    turnoActual=1;
    guardar();
    render();
  }
}

render();
</script>

</body>
</html>
