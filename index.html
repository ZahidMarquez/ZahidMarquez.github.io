<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>LISTA DE ESPERA GZOM</title>

<style>
:root{
  --azul:#0b2a5b; --gris:#eef1f5; --verde:#1b8f4c;
  --rojo:#b02a2a; --amarillo:#e8a317; --morado:#6b2cbf;
}

body{margin:0;font-family:Segoe UI,sans-serif;background:var(--gris);color:#000;}
body.dark{background:#121212;color:#fff;}
header{background:var(--azul);color:#fff;padding:14px;text-align:center;font-size:22px;}

.container{max-width:1400px;margin:auto;padding:16px;}
.card{background:#fff;padding:14px;border-radius:6px;margin-bottom:14px;box-shadow:0 4px 10px rgba(0,0,0,.1);}
body.dark .card{background:#1f1f1f;}
label{display:block;font-weight:600;font-size:12px;margin-bottom:4px;}
input,select{padding:8px;font-size:14px;width:100%;height:36px;box-sizing:border-box;border-radius:4px;}
button{border:none;padding:8px 12px;border-radius:4px;color:#fff;cursor:pointer;margin:4px;}
.primary{background:var(--azul);}
.llamar{background:var(--verde);}
.finalizar{background:#3a5aa8;}
.retirada{background:#777;}
.rojo{background:var(--rojo);}
.form-grid{display:grid;grid-template-columns:minmax(260px,2.5fr) minmax(90px,0.8fr) minmax(160px,1.2fr) minmax(160px,1.2fr);gap:14px;align-items:end;}
@media(max-width:900px){.form-grid{grid-template-columns:1fr;}}
.stats-container{display:flex;gap:12px;flex-wrap:wrap;}
.stat-card{flex:1 1 220px;padding:12px;border-radius:8px;color:#fff;text-align:center;}
.stat-total{background:var(--azul);}
.stat-pax{background:var(--verde);}
.stat-tarjeta{background:var(--amarillo);color:#000;}
.stat-promedio{background:var(--morado);}
.stat-atendidos{background:#555;}
.stat-mostrador{background:#444;}
table{width:100%;border-collapse:collapse;font-size:12px;}
th{background:var(--azul);color:#fff;padding:6px;}
td{border:1px solid #ccc;padding:5px;text-align:center;}
#atendidosContent{display:none;}
#toggleAtendidos{cursor:pointer;background:#444;color:#fff;padding:6px;border-radius:4px;}
</style>
</head>

<body>
<header>‚úà LISTA DE ESPERA</header>

<div class="container">

<div class="card">
  <div class="form-grid">
    <div>
      <label>Nombre</label>
      <input id="nombre" autocomplete="off">
    </div>
    <div>
      <label>Pax</label>
      <input id="cantidad" type="number" min="1" value="1">
    </div>
    <div>
      <label>Tarjeta</label>
      <select id="tarjeta">
        <option>Centurion</option>
        <option>Platino</option>
        <option>Aeromexico</option>
      </select>
    </div>
    <div>
      <label>Mostrador</label>
      <select id="mostrador">
        <option>Centurion</option>
        <option>Platino</option>
      </select>
    </div>
  </div>
  <button class="primary" onclick="registrar()">‚ûï Registrar e Imprimir Ticket</button>
</div>

<div class="card">
  <button class="primary" onclick="abrirPantalla('general')">üì∫ General</button>
  <button class="primary" onclick="abrirPantalla('platino')">üì∫ Platino</button>
  <button class="primary" onclick="abrirPantalla('centurion')">üì∫ Centurion</button>
  <button class="primary" onclick="exportarExcel()">üìä Excel</button>
  <button class="rojo" onclick="borrarHistorial()">üóëÔ∏è Historial</button>
  <button class="primary" onclick="toggleDark()">üåô Oscuro</button>
</div>

<div class="card stats-container">
  <div class="stat-card stat-total">En espera<br><h3 id="totalRegistros">0</h3></div>
  <div class="stat-card stat-pax">Pax en espera<br><h3 id="totalPax">0</h3></div>
  <div class="stat-card stat-tarjeta">
    Tarjetas<br>
    Centurion: <span id="countCenturion">0</span><br>
    Platino: <span id="countPlatino">0</span><br>
    Aero: <span id="countAeromexico">0</span>
  </div>
  <div class="stat-card stat-promedio">Promedio General<br><h3 id="promedioEspera">0</h3></div>
  <div class="stat-card stat-mostrador">Prom. Platino<br><h3 id="promedioPlatino">0</h3></div>
  <div class="stat-card stat-mostrador">Prom. Centurion<br><h3 id="promedioCenturion">0</h3></div>
  <div class="stat-card stat-atendidos">Pax Atendidos<br><h3 id="totalAtendidos">0</h3></div>
</div>

<div class="card">
<h3>Turnos en espera</h3>
<table>
<thead>
<tr>
<th>Turno</th><th>Nombre</th><th>Pax</th><th>Tarjeta</th>
<th>Mostrador</th><th>Registro</th><th>Llamada</th><th>Estado</th><th>Acciones</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>
</div>

<div class="card">
<div id="toggleAtendidos" onclick="toggleAtendidos()">Pasajeros Atendidos ‚ñº</div>
<div id="atendidosContent">
<table>
<thead>
<tr>
<th>Turno</th><th>Nombre</th><th>Pax</th><th>Tarjeta</th>
<th>Mostrador</th><th>Espera (min)</th>
</tr>
</thead>
<tbody id="tablaAtendidos"></tbody>
</table>
</div>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
let espera = JSON.parse(localStorage.getItem("espera")) || [];
let historial = JSON.parse(localStorage.getItem("historial")) || [];
let turnoActual = JSON.parse(localStorage.getItem("turnoActual")) || 1;
let atendidosVisible = false;

function registrar(){
  if(!nombre.value) return alert("Nombre requerido");
  const p = {
    turno: turnoActual++,
    nombre: nombre.value,
    cantidad: +cantidad.value,
    tarjeta: tarjeta.value,
    mostrador: mostrador.value,
    estado: "Pendiente",
    horaRegistro: new Date().toISOString(),
    horaLlamada: null
  };
  espera.push(p);
  guardar();
  imprimirTicket(p);
  nombre.value = ""; cantidad.value = 1;
  render();
}

function llamar(i){
  espera[i].estado="Llamado";
  espera[i].horaLlamada=new Date().toISOString();
  localStorage.setItem("ultimoLlamado",JSON.stringify(espera[i]));
  speechSynthesis.speak(new SpeechSynthesisUtterance(`Turno ${espera[i].turno}, mostrador ${espera[i].mostrador}`));
  guardar(); render();
}

function finalizar(i){
  const p = espera.splice(i,1)[0];
  p.estado = "Finalizado";
  if(!p.horaLlamada)p.horaLlamada=new Date().toISOString();
  historial.push(p);
  guardar(); render();
}

function retirada(i){
  const p = espera.splice(i,1)[0];
  p.estado="Retirado";
  historial.push(p);
  guardar(); render();
}

function render(){
  tabla.innerHTML="";
  espera.forEach((p,i)=>{
    tabla.innerHTML+=`
    <tr>
      <td>${p.turno}</td><td>${p.nombre}</td><td>${p.cantidad}</td>
      <td>${p.tarjeta}</td><td>${p.mostrador}</td>
      <td>${new Date(p.horaRegistro).toLocaleTimeString()}</td>
      <td>${p.horaLlamada?new Date(p.horaLlamada).toLocaleTimeString():'---'}</td>
      <td>${p.estado}</td>
      <td>
        <button class="llamar" onclick="llamar(${i})">Llamar</button>
        <button class="finalizar" onclick="finalizar(${i})">Finalizar</button>
        <button class="retirada" onclick="retirada(${i})">Retirada</button>
      </td>
    </tr>`;
  });

  const atendidos = historial.filter(p=>p.estado==="Finalizado");
  tablaAtendidos.innerHTML="";

  let sumG=0,sumP=0,sumC=0,cG=0,cP=0,cC=0;
  atendidos.forEach(p=>{
    const min=(new Date(p.horaLlamada)-new Date(p.horaRegistro))/60000;
    tablaAtendidos.innerHTML+=`
    <tr>
      <td>${p.turno}</td><td>${p.nombre}</td><td>${p.cantidad}</td>
      <td>${p.tarjeta}</td><td>${p.mostrador}</td><td>${min.toFixed(1)}</td>
    </tr>`;
    sumG+=min;cG++;
    if(p.mostrador==="Platino"){sumP+=min;cP++;}
    if(p.mostrador==="Centurion"){sumC+=min;cC++;}
  });

  totalRegistros.innerText = espera.length;
  totalPax.innerText = espera.reduce((a,b)=>a+b.cantidad,0);
  countCenturion.innerText = espera.filter(p=>p.tarjeta==="Centurion").length;
  countPlatino.innerText = espera.filter(p=>p.tarjeta==="Platino").length;
  countAeromexico.innerText = espera.filter(p=>p.tarjeta==="Aeromexico").length;

  promedioEspera.innerText = cG?(sumG/cG).toFixed(1):0;
  promedioPlatino.innerText = cP?(sumP/cP).toFixed(1):0;
  promedioCenturion.innerText = cC?(sumC/cC).toFixed(1):0;
  totalAtendidos.innerText = atendidos.reduce((a,b)=>a+b.cantidad,0);
}

function toggleAtendidos(){
  atendidosVisible = !atendidosVisible;
  atendidosContent.style.display = atendidosVisible?"block":"none";
  toggleAtendidos.innerText = atendidosVisible?"Pasajeros Atendidos ‚ñ≤":"Pasajeros Atendidos ‚ñº";
}

function imprimirTicket(p){
  const w = window.open("","","width=300,height=400");
  w.document.write(`<pre>
‚úà LISTA DE ESPERA
Turno: ${p.turno}
Nombre: ${p.nombre}
Pax: ${p.cantidad}
Tarjeta: ${p.tarjeta}
Mostrador: ${p.mostrador}
${new Date().toLocaleString()}
</pre>`);
  w.print(); w.close();
}

function abrirPantalla(tipo){
  const map={
    general:"pantalla_general.html",
    platino:"pantalla_platino.html",
    centurion:"pantalla_centurion.html"
  };
  window.open(map[tipo],tipo,"fullscreen=yes");
}

function exportarExcel(){
  const data=[["Turno","Nombre","Pax","Tarjeta","Mostrador","Registro","Llamada","Estado"]];
  [...espera,...historial].forEach(p=>{
    data.push([p.turno,p.nombre,p.cantidad,p.tarjeta,p.mostrador,p.horaRegistro,p.horaLlamada,p.estado]);
  });
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(data);
  XLSX.utils.book_append_sheet(wb,ws,"ListaEspera");
  XLSX.writeFile(wb,"ListaEspera.xlsx");
}

function borrarHistorial(){
  if(confirm("¬øBorrar historial y limpiar pantallas?")){
    historial = [];
    espera = [];
    turnoActual = 1;

    localStorage.setItem("historial", "[]");
    localStorage.setItem("espera", "[]");
    localStorage.setItem("turnoActual", "1");

    // ‚ö° se√±al para pantallas
    localStorage.setItem("limpiarPublico", Date.now().toString());

    render();
  }
}

function toggleDark(){document.body.classList.toggle("dark");}

function guardar(){
  localStorage.setItem("espera", JSON.stringify(espera));
  localStorage.setItem("historial", JSON.stringify(historial));
  localStorage.setItem("turnoActual", turnoActual);
}

render();
</script>
</body>
</html>
