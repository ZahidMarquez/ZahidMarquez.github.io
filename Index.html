<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>LISTA DE ESPERA GZOM</title>

<style>
:root{
  --azul:#0b2a5b; --gris:#eef1f5; --verde:#1b8f4c;
  --rojo:#b02a2a; --amarillo:#e8a317; --morado:#6b2cbf;
}

body{margin:0;font-family:Segoe UI,sans-serif;background:var(--gris);color:#000;}
body.dark{background:#121212;color:#fff;}

header{background:var(--azul);color:#fff;padding:14px;text-align:center;font-size:22px;}

.container{max-width:1300px;margin:auto;padding:16px;}
.card{background:#fff;padding:14px;border-radius:6px;margin-bottom:14px;box-shadow:0 4px 10px rgba(0,0,0,.1);}
body.dark .card{background:#1f1f1f;}

input,select{padding:6px;font-size:13px;width:100%;margin-top:4px;border-radius:4px;}
label{font-weight:600;font-size:12px;}

button{border:none;padding:8px 12px;border-radius:4px;color:#fff;cursor:pointer;margin-top:6px;margin-right:6px;}
.primary{background:var(--azul);}
.llamar{background:var(--verde);}
.finalizar{background:#3a5aa8;}
.retirada{background:#777;}
.rojo{background:var(--rojo);}

.stats-container{display:flex;gap:12px;flex-wrap:wrap;}
.stat-card{flex:1 1 200px;padding:12px;border-radius:8px;color:#fff;text-align:center;}
.stat-total{background:var(--azul);}
.stat-pax{background:var(--verde);}
.stat-tarjeta{background:var(--amarillo);color:#000;}
.stat-promedio{background:var(--morado);}
.stat-atendidos{background:#888;}

table{width:100%;border-collapse:collapse;font-size:12px;}
th{background:var(--azul);color:#fff;padding:6px;}
td{border:1px solid #ccc;padding:5px;text-align:center;}

.form-grid{display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:10px;}
@media(max-width:900px){.form-grid{grid-template-columns:1fr;}}

/* Atendidos plegable */
#atendidosContent{display:none;margin-top:10px;}
#atendidosToggle{background:#555;cursor:pointer;}
</style>
</head>

<body>
<header>‚úà LISTA DE ESPERA</header>

<div class="container">

<!-- FORMULARIO -->
<div class="card">
  <div class="form-grid">
    <div><label>Nombre</label><input id="nombre" autocomplete="off"></div>
    <div><label>Pax</label><input id="cantidad" type="number" min="1" value="1"></div>
    <div><label>Tarjeta</label>
      <select id="tarjeta"><option>Centurion</option><option>Platino</option><option>Aeromexico</option></select>
    </div>
    <div><label>Mostrador</label>
      <select id="mostrador"><option>Centurion</option><option>Platino</option></select>
    </div>
  </div>
  <button class="primary" onclick="registrar()">‚ûï Registrar e Imprimir Ticket</button>
</div>

<!-- BOTONES -->
<div class="card">
  <button class="primary" onclick="abrirPantalla()">üì∫ Pantalla P√∫blica</button>
  <button class="primary" onclick="exportarExcel()">üìä Exportar Excel</button>
  <button class="rojo" onclick="borrarHistorial()">üóëÔ∏è Borrar Historial</button>
  <button class="primary" onclick="toggleDark()">üåô Modo Oscuro</button>
</div>

<!-- ESTAD√çSTICAS -->
<div class="card stats-container">
  <div class="stat-card stat-total"><p>Turnos en espera</p><h3 id="totalRegistros">0</h3></div>
  <div class="stat-card stat-pax"><p>Total pasajeros</p><h3 id="totalPax">0</h3></div>
  <div class="stat-card stat-tarjeta">
    <p>Tarjetas</p>
    <h3>Cent: <span id="countCenturion">0</span></h3>
    <h3>Plat: <span id="countPlatino">0</span></h3>
    <h3>Aero: <span id="countAeromexico">0</span></h3>
  </div>
  <div class="stat-card stat-promedio"><p>Promedio espera (min)</p><h3 id="promedioEspera">0</h3></div>
  <div class="stat-card stat-atendidos"><p>Pasajeros atendidos</p><h3 id="totalAtendidos">0</h3></div>
</div>

<!-- TABLA ESPERA -->
<div class="card">
<h3>Turnos en espera</h3>
<table>
<thead>
<tr>
<th>Turno</th><th>Nombre</th><th>Pax</th><th>Tarjeta</th><th>Mostrador</th><th>Registro</th><th>Llamada</th><th>Estado</th><th>Acciones</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>
</div>

<!-- TABLA ATENDIDOS -->
<div class="card">
<h3 id="atendidosToggle" onclick="toggleAtendidos()">Pasajeros Atendidos ‚ñº</h3>
<div id="atendidosContent">
<table>
<thead>
<tr>
<th>Turno</th><th>Nombre</th><th>Pax</th><th>Tarjeta</th><th>Mostrador</th><th>Espera (min)</th>
</tr>
</thead>
<tbody id="tablaAtendidos"></tbody>
</table>
</div>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
const nombreInput=document.getElementById("nombre");
const cantidadInput=document.getElementById("cantidad");
const tarjeta=document.getElementById("tarjeta");
const mostrador=document.getElementById("mostrador");
const tabla=document.getElementById("tabla");
const tablaAtendidos=document.getElementById("tablaAtendidos");
const totalRegistros=document.getElementById("totalRegistros");
const totalPax=document.getElementById("totalPax");
const countCenturion=document.getElementById("countCenturion");
const countPlatino=document.getElementById("countPlatino");
const countAeromexico=document.getElementById("countAeromexico");
const promedioEspera=document.getElementById("promedioEspera");
const totalAtendidos=document.getElementById("totalAtendidos");
const atendidosToggle=document.getElementById("atendidosToggle");
const atendidosContent=document.getElementById("atendidosContent");

let espera=JSON.parse(localStorage.getItem("espera"))||[];
let historial=JSON.parse(localStorage.getItem("historial"))||[];
let turnoActual=JSON.parse(localStorage.getItem("turnoActual"))||1;

let pantalla=null;
let atendidosAbierto=true;

function toggleAtendidos(){
  atendidosAbierto=!atendidosAbierto;
  atendidosContent.style.display=atendidosAbierto?"block":"none";
  atendidosToggle.innerText=atendidosAbierto?"Pasajeros Atendidos ‚ñº":"Pasajeros Atendidos ‚ñ≤";
}

function registrar(){
  const nombre=nombreInput.value.trim();
  const cantidad=parseInt(cantidadInput.value);
  if(!nombre||cantidad<1){alert("Datos incompletos");return;}

  const pasajero={
    turno:turnoActual++,
    nombre,
    cantidad,
    tarjeta:tarjeta.value,
    mostrador:mostrador.value,
    estado:"Pendiente",
    horaRegistro:new Date().toISOString(),
    horaLlamada:null
  };

  espera.push(pasajero);
  guardarDatos();
  imprimirTicket(pasajero);
  nombreInput.value="";
  cantidadInput.value=1;
  render();
}

function llamar(i){
  const ahora=new Date().toISOString();
  espera[i].estado="Llamado";
  espera[i].horaLlamada=ahora;
  localStorage.setItem("ultimoLlamado",JSON.stringify(espera[i]));
  speechSynthesis.speak(
    new SpeechSynthesisUtterance(`Turno ${espera[i].turno}, mostrador ${espera[i].mostrador}`)
  );
  guardarDatos();
  render();
}

function finalizar(i){
  const p=espera.splice(i,1)[0];
  if(!p.horaLlamada)p.horaLlamada=new Date().toISOString();
  p.estado="Finalizado";
  historial.push(p);
  guardarDatos();
  render();
}

function retirada(i){
  const p=espera.splice(i,1)[0];
  p.estado="Retirado";
  historial.push(p);
  guardarDatos();
  render();
}

function guardarDatos(){
  localStorage.setItem("espera",JSON.stringify(espera));
  localStorage.setItem("historial",JSON.stringify(historial));
  localStorage.setItem("turnoActual",turnoActual);
  if(pantalla) actualizarPantalla();
}

function render(){
  // tabla de espera
  tabla.innerHTML="";
  espera.forEach((p,i)=>{
    tabla.innerHTML+=`
    <tr>
      <td>${p.turno}</td><td>${p.nombre}</td><td>${p.cantidad}</td><td>${p.tarjeta}</td>
      <td>${p.mostrador}</td><td>${new Date(p.horaRegistro).toLocaleTimeString()}</td>
      <td>${p.horaLlamada?new Date(p.horaLlamada).toLocaleTimeString():'---'}</td>
      <td>${p.estado}</td>
      <td>
        <button class="llamar" onclick="llamar(${i})">Llamar</button>
        <button class="finalizar" onclick="finalizar(${i})">Finalizar</button>
        <button class="retirada" onclick="retirada(${i})">Retirada</button>
      </td>
    </tr>`;
  });

  // estad√≠sticas
  totalRegistros.innerText=espera.length;
  totalPax.innerText=espera.reduce((a,b)=>a+b.cantidad,0);
  countCenturion.innerText=espera.filter(p=>p.tarjeta==="Centurion").length;
  countPlatino.innerText=espera.filter(p=>p.tarjeta==="Platino").length;
  countAeromexico.innerText=espera.filter(p=>p.tarjeta==="Aeromexico").length;

  // tabla atendidos
  tablaAtendidos.innerHTML="";
  const atendidos=historial.filter(p=>p.estado==="Finalizado");
  atendidos.forEach(p=>{
    const min=((new Date(p.horaLlamada)-new Date(p.horaRegistro))/60000).toFixed(1);
    tablaAtendidos.innerHTML+=`
      <tr>
        <td>${p.turno}</td><td>${p.nombre}</td><td>${p.cantidad}</td>
        <td>${p.tarjeta}</td><td>${p.mostrador}</td><td>${min}</td>
      </tr>`;
  });

  promedioEspera.innerText=atendidos.length
    ? (atendidos.reduce((a,p)=>a+(new Date(p.horaLlamada)-new Date(p.horaRegistro))/60000,0)/atendidos.length).toFixed(1)
    : 0;

  totalAtendidos.innerText=atendidos.reduce((a,b)=>a+b.cantidad,0);
}

// --- PANTALLA PUBLICA ---
function abrirPantalla(){
  if(!pantalla || pantalla.closed){
    pantalla=window.open("pantalla.html","pantalla","width=800,height=600");
  }
}

function actualizarPantalla(){
  if(!pantalla || pantalla.closed) return;
  pantalla.postMessage({espera,ultimo:espera.find(p=>p.estado==="Llamado")||null},"*");
}

function imprimirTicket(p){
  const w=window.open("","","width=300,height=400");
  w.document.write(`<pre>
‚úà LISTA DE ESPERA
Turno: ${p.turno}
Nombre: ${p.nombre}
Pax: ${p.cantidad}
Tarjeta: ${p.tarjeta}
Mostrador: ${p.mostrador}
${new Date().toLocaleString()}
</pre>`);
  w.print(); w.close();
}

function toggleDark(){document.body.classList.toggle("dark");}

function borrarHistorial(){
  if(confirm("¬øBorrar historial?")){
    historial=[];
    localStorage.setItem("historial","[]");
    localStorage.setItem("limpiarPublico","1");
    render();
  }
}

function exportarExcel(){
  const ws_data=[["Turno","Nombre","Pax","Tarjeta","Mostrador","Hora Registro","Hora Llamada","Estado"]];
  [...espera,...historial].forEach(p=>{
    ws_data.push([p.turno,p.nombre,p.cantidad,p.tarjeta,p.mostrador,p.horaRegistro,p.horaLlamada,p.estado]);
  });
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb,ws,"ListaEspera");
  XLSX.writeFile(wb,"ListaEspera.xlsx");
}

// actualizar cada segundo
setInterval(render,1000);

render();
</script>
</body>
</html>
